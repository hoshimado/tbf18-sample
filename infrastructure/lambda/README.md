# §4.1 APIの実装をLambdaでの呼び出し用に切り出し、Zip にしてS3に配置

## 本節の前提条件

本文「§3.3 バックエンドの設定を変更して再公開」にしたがって、
`.env.production.s3.ec2`を作成済みであり、
続くS3バケットへのアップロードおよびEC2等の再構築が完了していることを前提とします。


## 本節の操作手順

本文で案内している `lambda` フォルダー配下の構成は、以下の通りです（このファイルが置かれているフォルダーです）。

 * [infrastructure/lambda](./)

まず、コマンドラインを開いて `lambda` フォルダー直下に移動してください。  
その状態で、以下のコマンドを実行し、依存モジュールをインストールします。

```
npm install
```

続いて、以下のファイルを開いてください。

 * [./api/api_greeting.js](./api/api_greeting.js)

ファイル冒頭の以下の部分に、「[§3.3](../../backend/README.md#33-バックエンドの設定を変更して再公開)」で作成した  
`.env.production.s3.ec2` に含まれる次の設定値を反映します。

```
JWT_PUBLIC_KEY=＜JWT用の公開鍵を1行化したもの＞
```

この値を、次のような記述の `publicBase64` の部分にコピー＆ペーストしてください。  
（この値は、本文「§2.1.1 JWTへ署名する際に使うキーペアを作成」で生成した  
`id_rsa.pub.pem.base64.oneline.txt` の内容と同一です）

```js
publicBase64: '＜公開鍵を1行の文字列として出力したものを記載＞'
```

`api_greeting.js` の編集を終えて保存したら、
本文の手順にしたがって AWS Lambdaに配置するファイル一式をZipにまとめます。

この際に使用するスクリプトは、以下のファイルです。
本文の案内にしたがってリネームし、バッチファイルとして実行してください。

* [s3-build-lambda-zip.bat.txt](./s3-build-lambda-zip.bat.txt)




